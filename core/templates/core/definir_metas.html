{% extends 'core/base.html' %} 
{% load l10n %}

{% block content %}
<div class="container mt-4">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold text-dark">
      <i class="fas fa-bullseye text-primary me-2"></i>Gerenciar Metas
    </h4>
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#painelMetas" aria-expanded="false">
      <i class="fas fa-chart-pie me-2"></i>Ver Progresso
    </button>
  </div>

  <div class="collapse mb-4" id="painelMetas">
    <div class="row">
      <div class="col-md-6 mb-3">
        <div class="card border-success border-top-0 border-end-0 border-bottom-0 border-3 shadow-sm h-100">
          <div class="card-header bg-white fw-bold text-success">
            <i class="fas fa-piggy-bank me-2"></i>Metas de Poupança
          </div>
          <div class="card-body bg-light">
            {% for grupo in poupanca_display %}
                <h6 class="{{ grupo.cor_titulo }} fw-bold text-uppercase small mt-3 border-bottom pb-1">
                    {{ grupo.titulo }}
                </h6>
                {% for meta in grupo.lista %} 
                    {% include "core/includes/card_meta_simples.html" with meta=meta %} 
                {% endfor %} 
            {% empty %}
                <p class="text-muted small py-3">Nenhuma meta de economia definida.</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-3">
        <div class="card border-danger border-top-0 border-end-0 border-bottom-0 border-3 shadow-sm h-100">
          <div class="card-header bg-white fw-bold text-danger">
            <i class="fas fa-wallet me-2"></i>Limites de Gastos
          </div>
          <div class="card-body bg-light">
            {% for grupo in gastos_display %}
                <h6 class="{{ grupo.cor_titulo }} fw-bold text-uppercase small mt-3 border-bottom pb-1">
                    {{ grupo.titulo }}
                </h6>
                {% for meta in grupo.lista %} 
                    {% include "core/includes/card_meta_simples.html" with meta=meta %} 
                {% endfor %} 
            {% empty %}
                <p class="text-muted small py-3">Nenhum limite de gasto definido.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
      <h5 class="mb-0 text-dark fw-bold">
        <i class="fas fa-plus-circle text-primary me-2"></i>
        {% if form.instance.pk %}Editar Meta{% else %}Definir Nova Meta{% endif %}
      </h5>
    </div>
    <div class="card-body">
      <form method="POST">
        {% csrf_token %}

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">1. Período da Meta</label>
            {{ form.periodo }}
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">2. Tipo de Meta</label>
            {{ form.tipo }}
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-12" id="div-nome-meta" style="display: none;">
            <label class="form-label text-primary">Nome da Meta (Ex: Viagem Férias)</label>
            {{ form.descricao }}
          </div>

          <div class="col-md-12" id="div-datas-personalizadas" style="display: none;">
            <div class="p-3 bg-light border rounded">
              <small class="text-primary fw-bold d-block mb-2">Selecione o intervalo exato:</small>
              <div class="row">
                <div class="col-md-6">
                  <label class="small">Início</label>
                  {{ form.data_inicio }}
                </div>
                <div class="col-md-6">
                  <label class="small">Fim</label>
                  {{ form.data_fim }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 align-items-end">
          <div class="col-md-6" id="div_categoria" style="display: none;">
            <label class="form-label fw-bold">Categoria</label>
            {{ form.categoria }}
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Valor Alvo/Limite</label>
            {{ form.valor_limite }}
          </div>

          <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100 py-2">
              <i class="fas fa-save me-1"></i> Salvar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="mt-5">
    <h6 class="text-muted mb-3">Lista Rápida (Edição/Exclusão)</h6>
    <div class="list-group shadow-sm">
      {% for meta in metas %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          {% if meta.periodo == 'M' %}
            <span class="badge bg-info text-dark me-2">Mensal</span>
          {% elif meta.periodo == 'T' %}
            <span class="badge bg-warning text-dark me-2">Trimestral</span>
          {% elif meta.periodo == 'S' %}
            <span class="badge bg-primary me-2">Semestral</span>
          {% elif meta.periodo == 'A' %}
            <span class="badge bg-success me-2">Anual</span>
          {% elif meta.periodo == 'P' %}
            <span class="badge bg-dark me-2">Personalizado</span>
          {% endif %}

          <strong>{{ meta.temp_label }}</strong>
          <small class="text-muted d-block ms-1" style="font-size: 0.75rem;">{{ meta.temp_datas }}</small>
        </div>
        <div>
          <span class="fw-bold me-3 text-secondary">R$ {{ meta.valor_limite|floatformat:2 }}</span>
          <a href="{% url 'editar_meta' meta.id %}" class="btn btn-sm btn-light border text-primary" title="Editar">
            <i class="fas fa-pencil-alt"></i>
          </a>
          <a href="{% url 'excluir_meta' meta.id %}" class="btn btn-sm btn-light border text-danger" onclick="return confirm('Excluir?');" title="Excluir">
            <i class="fas fa-trash"></i>
          </a>
        </div>
      </div>
      {% empty %}
        <div class="list-group-item text-muted text-center py-3">Nenhuma meta cadastrada.</div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const elPeriodo = document.querySelector('[name="periodo"]');
    const elTipo = document.querySelector('[name="tipo"]');
    
    const divNome = document.getElementById("div-nome-meta");
    const divDatas = document.getElementById("div-datas-personalizadas");
    const divCategoria = document.getElementById("div_categoria");

    function atualizarCampos() {
      if (!elPeriodo || !elTipo) return;

      if (elPeriodo.value === "P") {
        divNome.style.display = "block";
        divDatas.style.display = "block";
      } else {
        divNome.style.display = "none";
        divDatas.style.display = "none";
      }

      if (elTipo.value === "C") {
        divCategoria.style.display = "block";
      } else {
        divCategoria.style.display = "none";
      }
    }

    if (elPeriodo) elPeriodo.addEventListener("change", atualizarCampos);
    if (elTipo) elTipo.addEventListener("change", atualizarCampos);

    atualizarCampos();

    // Máscara de Dinheiro
    const inputValor = document.getElementById('id_valor_limite'); 
    
    if (inputValor) {
        inputValor.addEventListener('input', function(e) {
            let value = e.target.value;
            value = value.replace(/\D/g, "");
            value = (value / 100).toFixed(2) + "";
            value = value.replace(".", ",");
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            e.target.value = "R$ " + value;
        });
    }
});
</script>
{% endblock %}